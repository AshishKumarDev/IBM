<html>
<head>
	
<title>Pics On A Map</title>

<!-- Google Fonts -->
<!-- Roboto -->
<link href='http://fonts.googleapis.com/css?family=Roboto:400,300,500,700' rel='stylesheet' type='text/css'>

<style type="text/css">
body {
	font-family: 'Roboto', sans-serif;
	margin: 0;
	overflow: hidden;	
	padding: 0;
}

.header {
	background-color: #4CAF50;
}

.header .tabs {
	height: 46px;
	position: relative;
}

.header .tabs .selected {
	border-bottom: solid 2px #B9F6CA;
	color: white;
}

.header .tabs p {
	border-bottom: solid 2px #4CAF50;
	color: rgba( 255, 255, 255, 0.70 );
	font-size: 14px;	
	line-height: 46px;
	margin: 0;
	padding: 0;
	position: absolute;	
	text-align: center;
	text-transform: uppercase;
}

.header .toolbar {
	color: white;
	font-size: 20px;
	height: 56px;
	line-height: 56px;
	margin: 0;
	padding: 0;
	padding-left: 24px;	
}

.list {
	left: 0;
	overflow-y: scroll;
	-webkit-overflow-scrolling: touch;	
	position: absolute;
	right: 0;
	top: 104px;
}

.list .item {
	background-position: center;
	background-repeat: no-repeat;
	background-size: cover;
	float: left; 
	height: 420px; 
	margin-left: 4px; 
	margin-top: 4px;
	overflow: hidden;	
	width: 420px;	
}

.list .item:last-of-type {
	margin-bottom: 5px;
}

.template {
	display: none;
}

.upload {
	background-color: #4CAF50;
	border-radius: 56px;
	bottom: 24px;
	box-shadow: 0 2px 8px rgba( 0, 0, 0, 0.40 );
	height: 56px;
	position: absolute;
	right: 24px;
	width: 56px;
}
</style>

<!-- Bluemix -->
<script src="script/IBMBluemix.min.js" type="text/javascript"></script>
<script src="script/IBMCloudCode.min.js" type="text/javascript"></script>

<!-- Application -->
<script type="text/javascript">
// Constants
var CLOUD_BASE_URL = 'http://localhost:3000';
var LIST_COLUMNS = 3;
var LIST_COLUMN_GAP = 4;
var PATH_CONFIGURATION = 'configuration.json';
var SERVICE_ATTACHMENT = '/attachment/';
var SERVICE_PICTURE = '/picture?limit=100';
var SERVICE_ROOT = '/pics-on-a-map/v1/apps/';

// Application
var configuration = null;
var ibmcloud = null;
var xhr = null;

function update( data ) 
{	
	var clone = null;
	var list = null;
	var template = null;
	
	// Debug
	console.log( 'Update.' );
	
	// Template
	template = document.querySelector( '.item.template' );
	
	// List
	list = document.querySelector( '.list' );
	
	for( var d = 0; d < data.length; d++ )
	{
		// Build list item
		// TODO: Cloud Code for binary data?
		clone = template.cloneNode( true );
		clone.setAttribute( 'data-id', data[d]._id );
		clone.style.backgroundImage = 
			'url( ' + 
			SERVICE_ROOT + 
			configuration.bluemix.applicationId + 
			SERVICE_ATTACHMENT + 
			data[d]._id + 
			' )';
		clone.style.width = Math.round( ( window.innerWidth - ( ( LIST_COLUMNS + 1 ) * LIST_COLUMN_GAP ) ) / LIST_COLUMNS ) + 'px';
		clone.style.height = Math.round( ( window.innerWidth - ( ( LIST_COLUMNS + 1 ) * LIST_COLUMN_GAP ) ) / LIST_COLUMNS ) + 'px';		
		clone.classList.remove( 'template' );
		
		// Append to list
		list.appendChild( clone );
	}
}

function doConfigurationLoad()
{
	// Debug
	console.log( 'Configuration loaded.' );
	
	// Configuration
	configuration = JSON.parse( xhr.responseText );
	
	// Bluemix
	IBMBluemix.initialize( configuration.bluemix );
	
	// Cloud Code
	ibmcloud = IBMCloudCode.initializeService();
	ibmcloud.setBaseUrl( CLOUD_BASE_URL );
	
	ibmcloud.get( SERVICE_PICTURE ).then( function( results )  {
		var data = null;
		
		// Debug
		console.log( 'Cloud Code.' );
		
		// Parse
		data = JSON.parse( results );
		
		// Update user interface
		update( data.docs );	
	}, function( error ) {
		console.log( error );
	} );
	
	// Clean up
	xhr.removeEventListener( 'load', doConfigurationLoad );
	xhr = null;
}

function doWindowLoad()
{
	// Debug
	console.log( 'Load.' );
	
	// Load configuration
	xhr = new XMLHttpRequest();
	xhr.addEventListener( 'load', doConfigurationLoad );
	xhr.open( 'GET', PATH_CONFIGURATION );
	xhr.send( null );
	
	doWindowResize();
}

function doWindowResize()
{
	var header = null;
	var list = null;
	var tabs = null;
	
	tabs = document.querySelectorAll( '.header .tabs p' );
	
	for( var t = 0; t < tabs.length; t++ )
	{
		tabs[t].style.width = Math.round( window.innerWidth / tabs.length ) + 'px';
		tabs[t].style.left = Math.round( ( window.innerWidth / tabs.length ) * t ) + 'px';
	}
	
	header = document.querySelector( '.header' );	
	
	list = document.querySelector( '.list' );
	list.style.height = Math.round( window.innerHeight - header.clientHeight ) + 'px';
}

window.addEventListener( 'load', doWindowLoad );
window.addEventListener( 'resize', doWindowResize );
</script>

</head>
<body>
	
<!-- Header -->
<div class="header">
	<p class="toolbar">Pics On A Map</p>
	<div class="tabs">
		<p class="selected">Stream</p>
		<p>Map</p>	
	</div>
</div>

<!-- List -->	
<div class="list"></div>
	
<!-- Add button -->
<div class="upload"></div>	
	
<!-- Template -->
<div class="item template"></div>	
	
</body>
</html>
