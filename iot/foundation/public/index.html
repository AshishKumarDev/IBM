<html>
<head>
    
<!-- Paho MQTT -->
<script src="mqttws31.js"></script>    
    
<!-- Application -->
<script type="text/javascript">
var CLIENT_PASSWORD = '0X7Jh&p!NYWf_Zfk+1';
var CLIENT_USER_NAME = 'a-asu2l5-n8nrugtarm';
var MQTT_CLIENT_ID = 'a:asu2l5:nodejs';
var MQTT_HOST = 'asu2l5.messaging.internetofthings.ibmcloud.com';
var MQTT_PORT = 1883;
var TOPIC_PUBLISH = 'iot-2/type/Photon/id/286cb6fb/cmd/testing/fmt/json';
var TOPIC_SUBSCRIBE = 'iot-2/type/Photon/id/286cb6fb/evt/testing/fmt/json';
    
// Application
var client = null;
var count = 0;
var interval = null;

// Connected to broker
// Subscribe for messages
function doClientSuccess( context )
{
    // Debug
    console.log( 'Connected.' );
    
    // Handle messages
    client.onMessageArrived = doMessageArrived;
    
    // Subscribe
    client.subscribe( 
        TOPIC_SUBSCRIBE,
        {onSuccess: doSubscribeSuccess}
    );
}
 
// Message arrive from broker
// Display to user
function doMessageArrived( message )
{
    var data = null;
    
    // Parse data
    // Display
    data = JSON.parse( message.payloadString );
    console.log( data.d.source + ': ' + data.d.count );
}
    
// Publish a new message
function doSend()
{
    var data = null;
    var message = null;
    
    // Increment counter
    count = count + 1;
    
    // Data object
    // Per IoT Foundation documentation
    data = {
        d: {
            source: 'browser',
            count: count
        }
    };
    
    // Assemble message
    // Set destination topic
    message = new Paho.MQTT.Message( JSON.stringify( data ) );
    message.destinationName = TOPIC_PUBLISH;
    
    // Send
    client.send( message );
}
    
// Subscribed to topic
function doSubscribeSuccess( context, granted ) 
{
    // Debug
    console.log( 'Subscribed.' );
    
    // Regular publish
    interval = setInterval( doSend, 1000 );
}
    
// Document loaded
// Connect to server
function doWindowLoad()
{
    // Debug
    console.log( 'Load.' );
    
    // Client
    client = new Paho.MQTT.Client(
        MQTT_HOST, 
        MQTT_PORT, 
        MQTT_CLIENT_ID
    );

    // Connect
    client.connect( {
        onSuccess: doClientSuccess,
        userName: CLIENT_USER_NAME,
        password: CLIENT_PASSWORD,
        cleanSession: true
    } );    
}
    
// Go    
window.addEventListener( 'load', doWindowLoad );
</script>

</head>
<body>

<!-- Empty -->    
    
</body>
</html>
