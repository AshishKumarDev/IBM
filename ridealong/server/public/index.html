<!DOCTYPE html>
<html>
<head>

<title>Ride Along</title>

<link href="https://js.arcgis.com/3.15/esri/css/esri.css" rel="stylesheet">    

<style type="text/css">
.list {
    border-right: solid 1px gray;
    bottom: 0;
    left: 0;
    position: absolute;
    top: 0;
    width: 200px;
}    
    
.list > p {
    border-bottom: solid 1px gray;
    cursor: default;
    height: 50px;
    line-height: 50px;
    margin: 0;
    padding: 0;
    padding-left: 10px;
}    
    
#map {
    bottom: 0;
    left: 201px;
    position: absolute;
    right: 0;
    top: 0;
}
</style>
 
<!-- ArcGIS -->
<script src="https://js.arcgis.com/3.15/"></script>    
    
<script type="text/javascript">
var line = null;
var log = null;
var map = null;
var xhr = null;    
    
function parse( line ) {
    var degrees = null;
    var index = null;
    var minutes = null;
    var parts = null;
    var result = {
        latitude: 0,
        longitude: 0
    };
    var value = null;
    
    parts = line.split( ',' );
    
    if( parts[0].indexOf( 'RMC' ) > 0 ) {
        value = parseFloat( parts[3] );
        index = parts[3].indexOf( '.' ) - 2;
        degrees = parseInt( parts[3].substr( 0, index ) );
        minutes = parseFloat( parts[3].substr( index ) );
        minutes = minutes / 60;
        result.latitude = degrees + minutes;        
        
        if( parts[4] == 'S' ) {
            result.latitude = 0 - result.latitude;
        }
        
        degrees = ( value / 100 );
        degrees = Math.floor( degrees * 100 ) / 100;
        minutes = value - ( degrees * 100 );
        result.longitude = degrees + minutes / 60;             
        
        value = parseFloat( parts[5] );
        index = parts[5].indexOf( '.' ) - 2;
        degrees = parseInt( parts[5].substr( 0, index ) );
        minutes = parseFloat( parts[5].substr( index ) );
        minutes = minutes / 60;
        result.longitude = degrees + minutes;                
        
        if( parts[6] == 'W' ) {
            result.longitude = 0 - result.longitude;
        }
        
        return result;
    } else {
        return null;
    }
}    

function doListLoad() {
    var data = null;
    var element = null;
    var list = null;
    
    data = JSON.parse( xhr.responseText );

    list = document.querySelector( '.list' );
    
    for( var d = 0; d < data.length; d++ ) {
        element = document.createElement( 'p' );
        element.innerHTML = data[d].name;
        element.setAttribute( 'data-url', data[d].url );
        element.addEventListener( 'click', doTrackClick );
        
        list.appendChild( element );
    }
    
    xhr.removeEventListener( 'load', doListLoad );
    xhr = null;
}    
    
function doTrackClick() {
    xhr = new XMLHttpRequest();
    xhr.addEventListener( 'load', doTrackLoad );
    xhr.open( 'GET', 'gps/' + this.getAttribute( 'data-url' ), true );
    xhr.send( null );
}    
    
function doTrackLoad() {
    log = xhr.responseText.split( '\n' );
    line = 0;
    
    require( [
        'esri/geometry/Point', 
        'esri/geometry/Polyline', 
        'esri/SpatialReference', 
        'esri/layers/layer', 
        'esri/graphic',
        'esri/symbols/SimpleLineSymbol',
        'esri/Color'
    ], function( Point, Polyline, SpatialReference, Layer, Graphic, SimpleLineSymbol, Color ) {
        var rmc = null;
        var path = null;
        var track = null;
        
        map.graphics.clear();
        
        path = [];
        
        for( var d = 0; d < log.length; d++ ) {
            rmc = parse( log[d] );

            if( rmc == null ) {
                continue;    
            }
            
            console.log( rmc );
            
            path.push( new Point( 
                rmc.longitude,
                rmc.latitude
            ) );
        }
        
        var symbol = new SimpleLineSymbol( SimpleLineSymbol.STYLE_SOLID, new Color( [0, 255, 0] ), 3 );
        
        track = new Polyline();
        track.addPath( path );
        
        map.graphics.add( new Graphic( track, symbol ) );   
        map.setExtent( track.getExtent(), true );
    } );
    
    xhr.removeEventListener( 'load', doTrackLoad );
    xhr = null;
}    

require( ['esri/map', 'dojo/domReady!'], function( Map ) {
    map = new Map( 'map', {
        center: [-118, 34.5],
        zoom: 8,
        basemap: 'topo'
    } );
    
    xhr = new XMLHttpRequest();
    xhr.addEventListener( 'load', doListLoad );
    xhr.open( 'GET', 'gps/list.json', true );
    xhr.send( null );    
} );        
</script>    
    
</head>
<body>

<div class="list"></div>
<div id="map"></div>
    
</body>
</html>
